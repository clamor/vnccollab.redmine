
    <html>
      <head><title>Test coverage for vnccollab.redmine.portlets.redmine_tickets</title>
      <style type="text/css">
        a {text-decoration: none; display: block; padding-right: 1em;}
        a:hover {background: #EFA;}
        hr {height: 1px; border: none; border-top: 1px solid gray;}
        .notcovered {background: #FCC;}
        .footer {margin: 2em; font-size: small; color: gray;}
      </style>
      </head>
      <body><h1>Test coverage for vnccollab.redmine.portlets.redmine_tickets</h1>
      <table>
    
<tr><td><a href="vnccollab.html">vnccollab/</a></td> <td style="background: red">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 70% (147 of 492 uncovered)</td></tr>
<tr><td><a href="vnccollab.redmine.html">&nbsp;&nbsp;&nbsp;&nbsp;redmine/</a></td> <td style="background: red">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 70% (147 of 492 uncovered)</td></tr>
<tr><td><a href="vnccollab.redmine.portlets.html">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;portlets/</a></td> <td style="background: yellow">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 92% (7 of 88 uncovered)</td></tr>
<tr><td><a href="vnccollab.redmine.portlets.redmine_tickets.html">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;redmine_tickets.py</a></td> <td style="background: yellow">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 92% (7 of 88 uncovered)</td></tr>
</table><hr/>
<pre>    1: import logging
    1: import textile
       
    1: from zope.component import getMultiAdapter
    1: from zope.formlib import form
    1: from zope.interface import implements
    1: from zope import schema
       
    1: from Products.Five.browser.pagetemplatefile import ZopeTwoPageTemplateFile
       
    1: from plone.portlets.interfaces import IPortletDataProvider
    1: from plone.app.portlets.portlets import base
       
    1: from vnccollab.redmine import messageFactory as _
    1: from vnccollab.redmine.util import RedmineUtil, logException
    1: from vnccollab.common.portlets import deferred
       
       
    1: logger = logging.getLogger('vnccollab.redmine.RedmineTicketsPortlet')
    1: util = RedmineUtil()
       
       
    2: class IRedmineTicketsPortlet(IPortletDataProvider):
       
    1:     header = schema.TextLine(
    1:         title=_(u"Header"),
    1:         description=_(u"Header of the portlet."),
    1:         required=True,
    1:         default=u'Redmine Tickets')
       
    1:     count = schema.Int(
    1:         title=_(u"Number of items to display"),
    1:         description=_(u"How many items to list."),
    1:         required=True,
    1:         default=5)
       
    1:     request_timeout = schema.Int(
    1:         title=_(u"Request timeout"),
    1:         description=_(u"How many seconds to wait for hanging Redmine request."),
    1:         required=True,
    1:         default=15)
       
       
    2: class Assignment(base.Assignment):
    1:     implements(IRedmineTicketsPortlet)
       
    1:     header = u''
    1:     count = 5
    1:     request_timeout = 15
       
    1:     @property
           def title(self):
               """Return portlet header"""
    1:         return self.header
       
    1:     def __init__(self, header=u'', count=5, request_timeout=15):
    4:         self.header = header
    4:         self.count = count
    4:         self.request_timeout = request_timeout
       
       
    2: class Renderer(deferred.DeferredRenderer):
       
    1:     render_preload = render_full = ZopeTwoPageTemplateFile(
    1:         'templates/redmine_tickets.pt')
       
    1:     def refresh(self):
               '''Calculates the data needed for deferred_update.'''
    1:         self.getTickets()
       
    1:     def getTickets(self):
               """Returns list of opened issues for authenticated user"""
    2:         try:
    2:             tickets = util.searchMyIssues(status_id='o', sort='updated_on:desc')
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         except:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             logException(msg=_(u"Error during fetching redmine tickets %s" %</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                                util._get_server_url),</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                          context=self.context, logger=logger)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             return ()</div>       
    2:         plone_view = getMultiAdapter((self.context, self.request),
    2:                                      name=u'plone')
    2:         url = util._get_server_url()
       
    6:         tickets = [x for x in tickets if x.id and x.subject]
    2:         tickets = tickets[:self.data.count]
    6:         result = tuple([self._dct_from_issue(x, plone_view, url) for x in tickets])
    2:         return result
       
    1:     def _dct_from_issue(self, issue, plone_view, url):
               '''Converts an issue in a dict.'''
    4:         try:
    4:             body = textile.textile(issue.description)
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         except:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             body = issue.description</div>    4:         date = plone_view.toLocalizedTime(issue.updated_on, long_format=1)
       
    4:         dct = {
    4:             'id': issue.id,
    4:             'title': issue.subject,
    4:             'body': body,
    4:             'date': date,
    4:             'url': '%s/issues/%s' % (url, issue.id)
               }
    4:         return dct
       
    1:     def getTicketsURL(self):
               """Returns tickets root url"""
    1:         return '%s/issues' % util._get_server_url()
       
    1:     @property
           def title(self):
               """return title of feed for portlet"""
    1:         return self.data.header
       
       
    2: class AddForm(base.AddForm):
    1:     form_fields = form.Fields(IRedmineTicketsPortlet)
    1:     label = _(u"Add Redmine Tickets Portlet")
    1:     description = _(u"Renders list of opened Redmine Tickets for authenticated "
                           "user.")
       
    1:     def create(self, data):
    1:         return Assignment(**data)
       
       
    2: class EditForm(base.EditForm):
    1:     form_fields = form.Fields(IRedmineTicketsPortlet)
    1:     label = _(u"Edit Redmine Tickets Portlet")
    1:     description = _(u"Renders list of opened Redmine Tickets for authenticated "
                           "user.")
</pre>

      <div class="footer">
      Generated for revision Niewersjonowany katalog on 2014-03-19 23:58:19.289888Z
      </div>
    </body>
    </html>

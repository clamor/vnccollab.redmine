
    <html>
      <head><title>Test coverage for vnccollab.redmine.browser.viewlets</title>
      <style type="text/css">
        a {text-decoration: none; display: block; padding-right: 1em;}
        a:hover {background: #EFA;}
        hr {height: 1px; border: none; border-top: 1px solid gray;}
        .notcovered {background: #FCC;}
        .footer {margin: 2em; font-size: small; color: gray;}
      </style>
      </head>
      <body><h1>Test coverage for vnccollab.redmine.browser.viewlets</h1>
      <table>
    
<tr><td><a href="vnccollab.html">vnccollab/</a></td> <td style="background: orange">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 82% (87 of 492 uncovered)</td></tr>
<tr><td><a href="vnccollab.redmine.html">&nbsp;&nbsp;&nbsp;&nbsp;redmine/</a></td> <td style="background: orange">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 82% (87 of 492 uncovered)</td></tr>
<tr><td><a href="vnccollab.redmine.browser.html">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;browser/</a></td> <td style="background: orange">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 84% (13 of 82 uncovered)</td></tr>
<tr><td><a href="vnccollab.redmine.browser.viewlets.html">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viewlets.py</a></td> <td style="background: orange">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 84% (13 of 82 uncovered)</td></tr>
</table><hr/>
<pre>    1: import logging
    1: from pyactiveresource.activeresource import ActiveResource
       
    1: from zope.interface import providedBy
    1: from zope.component import getUtility
       
    1: from plone.app.layout.viewlets import common
    1: from plone.memoize.instance import memoize
    1: from plone.registry.interfaces import IRegistry
       
    1: from Products.CMFCore.utils import getToolByName
    1: from Products.CMFPlone.utils import safe_unicode
    1: from Products.CMFPlone.interfaces.siteroot import IPloneSiteRoot
       
    1: from vnccollab.redmine import messageFactory as _
    1: from vnccollab.redmine.util import RedmineUtil, logException
       
       
    1: logger = logging.getLogger('vnccollab.redmine.RelatedRedmineTicketsViewlet')
    1: util = RedmineUtil()
       
       
    2: class RelatedRedmineTicketsViewlet(common.ViewletBase):
    1:     """Lists redmine tickets assigned to current object"""
       
    1:     def update_new(self):
               # TODO: remove update and replace it by this.
               # But before that we need, to change searchIssues and add searchMyIssues
               # and update cloudstream
    1:         if IPloneSiteRoot in providedBy(self.context):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             return</div>       
    1:         uuid = self.context.UID()
    1:         field_key = self._get_field_key()
    1:         url = util._get_server_url()
       
    1:         try:
    1:             issues = util.searchIssues(**{field_key: uuid,
    1:                                           'status_id': 'o',
    1:                                           'sort': 'updated_on:desc'})
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         except:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             logException(logger=logger, context=self.context,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                          msg=_(u"Error during fetching redmine tickets %s"</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                                % url))</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             issues = []</div>       
               # TODO: convert to dic
    3:         self.tickets = [self._ticket_from_issue(x, url) for x in issues]
       
    1:     def _ticket_from_issue(self, issue, url):
    2:         ticket = {
    2:             'id': issue.id,
    2:             'title': issue.subject,
    2:             'body': issue.description,
    2:             'url': '%s/issues/%s' % (url, issue.id)
               }
    2:         return ticket
       
    1:     def _get_field_key(self):
               '''Returns the name of the Remine key that is used to store plone
               UUIDs.'''
    1:         registry = getUtility(IRegistry)
    1:         field_id = registry.get('vnccollab.redmine.plone_uid_field_id')
    1:         field_key = 'cf_%d' % field_id
    1:         return field_key
       
    1:     def update(self):
    1:         self.tickets = ()
       
    1:         if IPloneSiteRoot in providedBy(self.context):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             return</div>       
    1:         tickets = []
               # check if settings are configured
               # check user redmine credentials and redmine url/field id
    1:         registry = getUtility(IRegistry)
    1:         url = registry.get('vnccollab.redmine.server_url')
    1:         field_id = registry.get('vnccollab.redmine.plone_uid_field_id')
    1:         username, password = self.getAuthCredentials()
    1:         if username and password and url and field_id:
    1:             Issue = type("Issue", (ActiveResource,), {'_site': url, '_user':
    1:                          username, '_password': password})
                   # do actual calls to redmine
    1:             try:
                       # fetch opened issues belonging to authenticated user
    1:                 uuid = self.context.UID()
    1:                 data = Issue.find(**{'cf_%d' % field_id: uuid,
    1:                                      'status_id': 'o',
    1:                                      'sort': 'updated_on:desc'})
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             except Exception:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 logException(logger=logger, context=self.context,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                              msg=_(u"Error during fetching redmine tickets %s"</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                                    % url))</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 return</div>       
    3:             for item in data:
    2:                 info = item.to_dict()
       
                       # skip invalid entries
    2:                 if not info.get('id') or not info.get('subject'):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                     continue</div>       
    2:                 tickets.append({
    2:                     'id': info['id'],
    2:                     'title': safe_unicode(info['subject']),
    2:                     'body': safe_unicode(info.get('description', '')),
    2:                     'url': '%s/issues/%s' % (url, info['id'])
                       })
       
    1:         self.tickets = tuple(tickets)
       
    1:     @memoize
           def getAuthCredentials(self):
               """Returns username and password for redmine user."""
               # take username and password from authenticated user Zimbra creds
    1:         mtool = getToolByName(self.context, 'portal_membership')
    1:         member = mtool.getAuthenticatedMember()
    1:         username = member.getProperty('redmine_username') or ''
    1:         password = member.getProperty('redmine_password') or ''
               # password could contain non-ascii chars, ensure it's properly encoded
    1:         return username, safe_unicode(password).encode('utf-8')
       
</pre>

      <div class="footer">
      Generated for revision Niewersjonowany katalog on 2014-03-20 17:31:58.681320Z
      </div>
    </body>
    </html>
